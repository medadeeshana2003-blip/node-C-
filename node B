#include <SPI.h>
#include <LoRa.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

/* ---------- OLED ---------- */
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define OLED_ADDR 0x3C

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

/* ---------- LoRa Pins (ESP32) ---------- */
#define SS    5
#define RST   14
#define DIO0  26
#define SCK   18
#define MISO  19
#define MOSI  23

#define LORA_BAND 433E6

/* ---------- Node A data ---------- */
int   Light = -1;
float Temperature = -1;
float Humidity = -1;

/* ---------- Node C data ---------- */
int   Soil = -1;
float Flow = -1;
float Total = -1;
bool  Pump = false;

/* ---------- State ---------- */
bool gotA = false;
bool gotC = false;
bool showA = true;

unsigned long lastSwitch = 0;
const unsigned long SWITCH_MS = 2000;

/* ---------- OLED helpers ---------- */
void drawWaiting() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);
  display.println("Gateway Ready");
  display.println("LoRa OK");
  display.println("----------------");
  display.println("Waiting for data");
  display.display();
}

void drawNodeA() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);

  display.println("Node A - Environment");
  display.println("----------------");
  display.print("Light : "); display.println(Light);
  display.print("Temp  : "); display.print(Temperature, 1); display.println(" C");
  display.print("Hum   : "); display.print(Humidity, 1); display.println(" %");
  display.display();
}

void drawNodeC() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);

  display.println("Node C - Irrig");
  display.println("----------------");
  display.print("Soil : "); display.println(Soil);
  display.print("Pump : "); display.println(Pump ? "ON" : "OFF");
  display.print("Flow : "); display.print(Flow, 1); display.println(" L/m");
  display.print("Total: "); display.print(Total, 2); display.println(" L");
  display.display();
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("Node B (Gateway) starting...");

  /* OLED init */
  Wire.begin(21, 22);
  if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDR)) {
    Serial.println("OLED not found");
    while (1);
  }

  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(WHITE);
  display.setCursor(0, 0);
  display.println("Gateway Ready");
  display.println("----------------");
  display.display();

  /* LoRa init */
  SPI.begin(SCK, MISO, MOSI, SS);
  LoRa.setPins(SS, RST, DIO0);

  if (!LoRa.begin(LORA_BAND)) {
    Serial.println("LoRa init failed");
    display.clearDisplay();
    display.setCursor(0, 0);
    display.println("LoRa FAILED");
    display.display();
    while (1);
  }

  Serial.println("LoRa init OK");
  display.println("LoRa OK");
  display.display();
  delay(1500);

  drawWaiting();
}

void loop() {

  /* ---------- RECEIVE ---------- */
  int packetSize = LoRa.parsePacket();
  if (packetSize) {
    String incoming = "";
    while (LoRa.available()) {
      incoming += (char)LoRa.read();
    }

    Serial.print("Received: ");
    Serial.println(incoming);

    /* ---------- NODE A ---------- */
    if (incoming.startsWith("ID=A")) {
      // Format: ID=A Light=1234 Temp=28.4 Hum=65.2
      sscanf(incoming.c_str(),
             "ID=A Light=%d Temp=%f Hum=%f",
             &Light, &Temperature, &Humidity);

      gotA = true;
      showA = true;
      drawNodeA();
    }

    /* ---------- NODE C ---------- */
    if (incoming.startsWith("ID=C")) {
      // Format: ID=C Soil=520 Pump=ON Flow=2.3 Total=1.45
      char pumpStr[6] = {0};

      sscanf(incoming.c_str(),
             "ID=C Soil=%d Pump=%5s Flow=%f Total=%f",
             &Soil, pumpStr, &Flow, &Total);

      Pump = (String(pumpStr) == "ON");
      gotC = true;

      if (!gotA) showA = false;
      drawNodeC();
    }
  }

  /* ---------- SCREEN SWITCH ---------- */
  if (gotA && gotC && millis() - lastSwitch > SWITCH_MS) {
    lastSwitch = millis();
    showA = !showA;

    if (showA) drawNodeA();
    else       drawNodeC();
  }

  /* ---------- NO DATA ---------- */
  if (!gotA && !gotC) {
    drawWaiting();
    delay(300);
  }
}
